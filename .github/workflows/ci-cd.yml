# CI/CD Workflow
# Runs tests, builds the application, and deploys to GitHub Pages
# Learn more about GitHub Actions: https://docs.github.com/en/actions
name: CI/CD

# Trigger conditions: runs on pushes to main and on all pull requests
# Documentation: https://docs.github.com/en/actions/writing-workflows/choosing-when-your-workflow-runs/events-that-trigger-workflows
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

# Token permissions: explicitly grant only what's needed (principle of least privilege)
# Learn more: https://docs.github.com/en/actions/security-for-github-actions/security-guides/automatic-token-authentication#permissions-for-the-github_token
permissions:
  contents: read

# Concurrency control: prevents multiple deployments from running simultaneously
# Allows PR workflows to be cancelled when new commits are pushed
# Documentation: https://docs.github.com/en/actions/writing-workflows/choosing-what-your-workflow-does/control-the-concurrency-of-workflows-and-jobs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

jobs:
  # Build job: compiles and packages the application
  # Runs unit tests to validate code quality before building
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: read             # Required to read Pages configuration
      id-token: write         # Required for OIDC token to request Sigstore signing certificate
      attestations: write     # Required to persist the attestation
      artifact-metadata: write # Required to generate artifact metadata storage records
    steps:
      # Checkout code from the repository
      # Pinned to full commit SHA for security: https://docs.github.com/en/actions/security-for-github-actions/security-guides/automatic-token-authentication#permissions-for-the-github_token
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      
      # Configure Pages to get the site URL
      # This reads the custom domain (if configured) or generates github.io URL
      # Outputs: base_url (the full URL like https://chrisreddington.com/timestamp)
      - name: Configure Pages
        id: pages
        uses: actions/configure-pages@983d7736d9b0ae728b81ab479565c72886d7745b # v5.0.0
      
      # Setup Node.js using version specified in .node-version file
      # Caching npm dependencies speeds up subsequent runs
      # Learn more: https://github.com/actions/setup-node#caching-global-packages-data
      - name: Setup Node
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version-file: '.node-version'
          cache: 'npm'
          
      # Install exact versions from package-lock.json
      # Using 'npm ci' ensures reproducible builds and is faster than 'npm install'
      # Documentation: https://docs.npmjs.com/cli/v10/commands/npm-ci
      - name: Install dependencies
        run: npm ci

      # Validate build scripts before running them
      # This catches type errors and import path issues in scripts/
      - name: Validate build scripts
        run: npm run validate:scripts
        
      # Run unit tests with Vitest
      - name: Run unit tests
        run: npm run test
        
      # Build the production bundle with Vite
      # VITE_SITE_URL from Pages configuration (respects custom domains)
      - name: Build
        run: npm run build
        env:
          VITE_SITE_URL: ${{ steps.pages.outputs.base_url }}

      # Upload build artifact for other jobs to consume
      # This artifact is used by deploy job
      - name: Upload build artifact
        id: upload
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: dist
          path: ./dist
          retention-days: 7
          if-no-files-found: error

      # Generate build provenance attestation for supply chain security
      # Creates a cryptographically signed attestation of build origin
      # Uses the artifact digest from upload-artifact for precise attestation
      # Only runs on public repositories as private repos cannot publish attestations
      # Note: Attestations API only supports public repositories
      # Learn more: https://docs.github.com/en/actions/security-guides/using-artifact-attestations-to-establish-provenance-for-builds
      - name: Generate artifact attestation
        if: github.ref == 'refs/heads/main' && !github.event.repository.private
        uses: actions/attest-build-provenance@00014ed6ed5efc5b1ab7f7f34a39eb55d41aa4f8 # v3.1.0
        with:
          subject-name: dist
          subject-digest: sha256:${{ steps.upload.outputs.artifact-digest }}

  # End-to-End tests (reusable workflow)
  # Runs only on pushes to main in this workflow; PR label-based runs are handled by a dedicated workflow
  e2e:
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    uses: ./.github/workflows/e2e.yml
    secrets: inherit

  # Lighthouse baseline: capture current production metrics before deployment
  # Runs in parallel with build/e2e to capture pre-deployment baseline
  # Uses composite action for Lighthouse collection and score extraction
  # Note: PWA audits were deprecated in Lighthouse - see https://developer.chrome.com/blog/update-install-criteria
  # Learn more: https://github.com/GoogleChrome/lighthouse-ci
  lighthouse-baseline:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read
    outputs:
      baseline-performance: ${{ steps.lighthouse.outputs.performance }}
      baseline-accessibility: ${{ steps.lighthouse.outputs.accessibility }}
      baseline-best-practices: ${{ steps.lighthouse.outputs.best-practices }}
      baseline-seo: ${{ steps.lighthouse.outputs.seo }}
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      # Run Lighthouse against current production site (before new deployment)
      - name: Run Lighthouse on current production
        id: lighthouse
        uses: ./.github/actions/lighthouse-audit
        with:
          url: 'https://chrisreddington.com/timestamp/'
          artifact-name: lighthouse-baseline

  # Deploy to GitHub Pages and run Lighthouse audit with comparison
  # This job runs only after build, e2e, and lighthouse-baseline succeed, and only on main branch
  # Documentation: https://docs.github.com/en/pages/getting-started-with-github-pages/configuring-a-publishing-source-for-your-github-pages-site#publishing-with-a-custom-github-actions-workflow
  deploy:
    # Required permissions for GitHub Pages deployment
    # Learn more: https://docs.github.com/en/actions/writing-workflows/choosing-what-your-workflow-does/controlling-permissions-for-github_token
    permissions:
      contents: read    # Read repository contents
      pages: write      # Deploy to Pages
      id-token: write   # Verify deployment originates from an appropriate source
    # GitHub Pages environment configuration
    # Using 'production' allows applying deployment protection rules in the future
    # Learn more: https://docs.github.com/en/actions/deployment/targeting-different-environments/using-environments-for-deployment
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: [build, e2e, lighthouse-baseline]
    if: github.ref == 'refs/heads/main'
    steps:
      # Checkout needed for composite action access
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      # Download the build artifact from the build job
      - name: Download build artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: dist
          path: ./dist

      # Upload artifact for GitHub Pages deployment
      # Learn more: https://github.com/actions/upload-pages-artifact
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@7b1f4a764d45c48632c6b24a0339c27f5614fb0b # v4.0.0
        with:
          path: ./dist

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e # v4.0.5

      # Wait briefly for GitHub Pages CDN to propagate the new deployment
      - name: Wait for deployment propagation
        run: sleep 10

      # Run Lighthouse against newly deployed site using composite action
      - name: Run Lighthouse on new deployment
        id: lighthouse
        uses: ./.github/actions/lighthouse-audit
        with:
          url: ${{ steps.deployment.outputs.page_url }}
          artifact-name: lighthouse-after-deploy

      # Compare new deployment against baseline and generate summary
      - name: Generate Lighthouse comparison summary
        env:
          BASELINE_PERF: ${{ needs.lighthouse-baseline.outputs.baseline-performance }}
          BASELINE_A11Y: ${{ needs.lighthouse-baseline.outputs.baseline-accessibility }}
          BASELINE_BP: ${{ needs.lighthouse-baseline.outputs.baseline-best-practices }}
          BASELINE_SEO: ${{ needs.lighthouse-baseline.outputs.baseline-seo }}
          NEW_PERF: ${{ steps.lighthouse.outputs.performance }}
          NEW_A11Y: ${{ steps.lighthouse.outputs.accessibility }}
          NEW_BP: ${{ steps.lighthouse.outputs.best-practices }}
          NEW_SEO: ${{ steps.lighthouse.outputs.seo }}
        run: |
          # Calculate deltas
          DELTA_PERF=$((NEW_PERF - BASELINE_PERF))
          DELTA_A11Y=$((NEW_A11Y - BASELINE_A11Y))
          DELTA_BP=$((NEW_BP - BASELINE_BP))
          DELTA_SEO=$((NEW_SEO - BASELINE_SEO))
          
          # Function to format delta with emoji
          format_delta() {
            local delta=$1
            if [ "$delta" -gt 0 ]; then
              echo "ðŸŸ¢ +${delta}"
            elif [ "$delta" -lt 0 ]; then
              echo "ðŸ”´ ${delta}"
            else
              echo "âšª Â±0"
            fi
          }
          
          # Generate job summary
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸ”¦ Lighthouse Performance Report
          
          Comparison of Lighthouse scores before and after deployment.
          
          | Metric | Before | After | Change |
          |--------|--------|-------|--------|
          | **Performance** | ${BASELINE_PERF}% | ${NEW_PERF}% | $(format_delta $DELTA_PERF) |
          | **Accessibility** | ${BASELINE_A11Y}% | ${NEW_A11Y}% | $(format_delta $DELTA_A11Y) |
          | **Best Practices** | ${BASELINE_BP}% | ${NEW_BP}% | $(format_delta $DELTA_BP) |
          | **SEO** | ${BASELINE_SEO}% | ${NEW_SEO}% | $(format_delta $DELTA_SEO) |
          
          ---
          
          **URL tested:** ${{ steps.deployment.outputs.page_url }}
          
          ðŸ“Š View detailed reports in the uploaded artifacts.
          EOF
          
          echo "Lighthouse comparison complete!"
