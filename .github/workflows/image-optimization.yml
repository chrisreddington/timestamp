# Image Optimization Workflow
# Automatically compresses and optimizes images in pull requests
# Learn more: https://github.com/calibreapp/image-actions
name: Image Optimization

# Trigger on pull requests that modify image files
# Documentation: https://docs.github.com/en/actions/writing-workflows/choosing-when-your-workflow-runs/events-that-trigger-workflows
on:
  pull_request:
    paths:
      - '**/*.png'
      - '**/*.jpg'
      - '**/*.jpeg'
      - '**/*.webp'
      - '**/*.gif'
      - '**/*.svg'

# Token permissions: explicitly grant only what's needed
# Learn more: https://docs.github.com/en/actions/security-for-github-actions/security-guides/automatic-token-authentication#permissions-for-the-github_token
permissions:
  contents: write  # Required to commit optimized images back to the PR
  pull-requests: write  # Required to post comments with optimization results

jobs:
  # Optimize images using calibreapp/image-actions
  # Uses Sharp and other high-quality compression algorithms
  optimize-images:
    runs-on: ubuntu-latest
    # Skip optimization on forks as they can't commit back
    if: github.event.pull_request.head.repo.full_name == github.repository
    steps:
      # Checkout code from the PR branch
      # Pinned to full commit SHA for security: https://docs.github.com/en/actions/security-for-github-actions/security-guides/security-hardening-for-github-actions#using-third-party-actions
      - name: Checkout PR branch
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      # Optimize images with calibreapp/image-actions
      # This action:
      # - Uses mozjpeg for JPEG compression
      # - Uses pngquant for PNG compression  
      # - Optimizes SVG files
      # - Converts to WebP when beneficial
      # - Posts before/after comparison in PR comments
      # Learn more: https://github.com/calibreapp/image-actions
      - name: Compress Images
        id: optimize
        uses: calibreapp/image-actions@f32575787d333b0579f0b7d506ff03be63a669d1 # v1.4.1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Quality settings (0-100)
          jpegQuality: 85
          pngQuality: 85
          webpQuality: 85
          # Ignore node_modules and other build artifacts
          ignorePaths: |
            node_modules/**
            dist/**
            .git/**

      # Upload compression report as artifact for debugging
      - name: Upload optimization report
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: steps.optimize.outputs.markdown != ''
        with:
          name: image-optimization-report
          path: .image-actions-results.json
          retention-days: 30
          if-no-files-found: ignore
